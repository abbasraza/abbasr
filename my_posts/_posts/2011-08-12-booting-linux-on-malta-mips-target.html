---
layout: post
title: Booting Linux on Malta MIPS target using Qemu
date: '2011-08-12T00:06:00.003+05:00'
author: Abbas Raza
tags:
- mips linux
- Malta mips
- qemu mips
- initrd
- busybox
modified_time: '2011-08-12T00:10:11.245+05:00'
blogger_id: tag:blogger.com,1999:blog-3367966882409306161.post-7465491663456816347
blogger_orig_url: https://abbas-raza.blogspot.com/2011/08/booting-linux-on-malta-mips-target.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">Here are some steps to emulate Linux on Malta MIPS target using Qemu</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /><b>Download and Install toolchain for MIPS:</b></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br />Download and install toolchain for mips. I am using &nbsp;"Sourcery CodeBench Lite 2011.03-93 for MIPS GNU/Linux " &nbsp;which can be download from this link http://www.codesourcery.com/sgpp/lite/mips/portal/release1872</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br />Modify path accordingly PATH=/home/abbas/toolchains/CodeSourcery/Sourcery_CodeBench_Lite_for_MIPS_GNU_Linux/bin/:$PATH</span><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /><br /><b>Linux Kernel Compilation for Malta MIPS:</b></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br />Get vanilla linux kernel and follow setps to configure and compile it for little endian mips malta target</span><br /><ul style="text-align: left;"><li><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">make ARCH=mips CROSS_COMPILE=mips-linux-gnu- CFLAGS=EL menuconfig<br /><br />Machine Selection: MIPS Malta board<br /><br />Endianess selection: (Little endian)<br /><br />CPU selection: MIPS32 Release 2<br /><br />Initrd support:<br />General setup --&gt; BLK_DEV_INITRD[y]<br /><br /></span></li>
 <li><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">make ARCH=mips CROSS_COMPILE=mips-linux-gnu- CFLAGS=EL&nbsp;</span></li>
 </ul><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">This will build vmlinux kernel image.</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /><b>BusyBox compilation for Little Endian MIPS:</b></span><br /><div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br />Download latest busybox and follow setps to configure and compile it for mips little endian system</span></div><div><ul style="text-align: left;"><li><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">make CROSS_COMPILE=mips-linux-gnu- CFLAGS='-EL -static' LDFLAGS=-EL V=1 defconfig</span></li>
 </ul></div><div><ul style="text-align: left;"><li><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">make CROSS_COMPILE=mips-linux-gnu- CFLAGS='-EL -static' LDFLAGS=-EL V=1<br /><br /></span></li>
 <li><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">make CROSS_COMPILE=mips-linux-gnu- CFLAGS='-EL -static' LDFLAGS=-EL V=1 CONFIG_PREFIX=./RFS_RAMD install<br /></span></li>
 </ul></div></div><div><b><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br />Creating minimal Initrd image:</span></b></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br />Copy and save following script to create very minimal initrd image from busybox</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><b><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">####### initrd.sh START #############</span></b></div><div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">#!/bin/bash</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Housekeeping...</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">rm -f /tmp/ramdisk.img</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">rm -f /tmp/ramdisk.img.gz</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Ramdisk Constants</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">RDSIZE=4000</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">BLKSIZE=1024</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Create an empty ramdisk image</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">dd if=/dev/zero of=/tmp/ramdisk.img bs=$BLKSIZE count=$RDSIZE</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Make it an ext2 mountable file system</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">mke2fs -F -m 0 -b $BLKSIZE /tmp/ramdisk.img $RDSIZE</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Mount it so that we can populate</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">mount /tmp/ramdisk.img /mnt/initrd -t ext2 -o loop=/dev/loop0</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Populate the filesystem (subdirectories)</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">mkdir /mnt/initrd/sys</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">mkdir /mnt/initrd/dev</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">mkdir /mnt/initrd/proc</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Grab busybox and create the symbolic links</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">cp -r RFS_RAMD/* /mnt/initrd/</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Grab the necessary dev files</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">sudo mknod /mnt/initrd/dev/console c 5 1</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">sudo mknod /mnt/initrd/dev/null c 3 1</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"># Finish up...</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">umount /mnt/initrd</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">gzip -9 /tmp/ramdisk.img</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">cp /tmp/ramdisk.img.gz initrd.gz</span></div></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><div><b><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">####### initrd.sh END #############</span></b></div><div></div></div><div><b><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></b></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">Run this script with sudo and it will create initrd image in current directory.</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><b>Finally</b></span><b><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">&nbsp;booting images with Qemu:<br /></span></b><br /><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">Install Qemu on you host and run following command to boot linux</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><i>qemu-system-mipsel -M malta -m 256 -no-reboot &nbsp;-hda /dev/zero -initrd initrd.gz -kernel vmlinux -append "panic=1 console=ttyS0 ramdisk_size=175940"</i>&nbsp;</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">*adjust ramdisk_size accordingly in kernel parameters.</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><b><i>Sample Log :-)</i></b></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"></span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">abbas@dell-ubuntu:linux-2.6.38.6$ qemu-system-mipsel -M malta -m 256 -no-reboot &nbsp;-hda /dev/zero -initrd ../../busybox-1.18.5/initrd.gz -kernel vmlinux -append "panic=1 console=ttyS0 ramdisk_size=175940" &nbsp;-nographic</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Initializing cgroup subsys cpuset</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Initializing cgroup subsys cpu</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Linux version 2.6.38.6 (abbas@dell-ubuntu) (gcc version 4.5.2 (Sourcery CodeBench Lite 2011.03-93) ) #2 Thu Aug 11 18:22:52 PKT 2011</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] bootconsole [early0] enabled</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] CPU revision is: 00019300 (MIPS 24Kc)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] FPU revision is: 00000000</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Determined physical RAM map:</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] &nbsp;memory: 00001000 @ 00000000 (reserved)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] &nbsp;memory: 000ef000 @ 00001000 (ROM data)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] &nbsp;memory: 0083c000 @ 000f0000 (reserved)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] &nbsp;memory: 0f6d4000 @ 0092c000 (usable)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Wasting 75136 bytes for tracking 2348 unused pages</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Initial ramdisk at: 0x8092c000 (1090394 bytes)</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Zone PFN ranges:</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] &nbsp; DMA &nbsp; &nbsp; &nbsp;0x00000000 -&gt; 0x00001000</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] &nbsp; Normal &nbsp; 0x00001000 -&gt; 0x00010000</span><br /><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.000000] Movable zone start PFN for each node</span><br /><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><skipped></skipped></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.476000] rtc_cmos rtc_cmos: setting system clock to 2011-08-11 13:02:25 UTC (1313067745)</span><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"></span><br /><div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.564000] input: AT Raw Set 2 keyboard as /devices/platform/i8042/serio0/input/input0</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.596000] ata1.00: ATA-7: QEMU HARDDISK, 0.12.3, max UDMA/100</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.600000] ata1.00: 0 sectors, multi 16: LBA&nbsp;</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.600000] ata2.00: ATAPI: QEMU DVD-ROM, 0.12.3, max UDMA/100</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.600000] ata2.00: configured for UDMA/33</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.600000] ata1.00: configured for UDMA/33</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.608000] scsi 0:0:0:0: Direct-Access &nbsp; &nbsp; ATA &nbsp; &nbsp; &nbsp;QEMU HARDDISK &nbsp; &nbsp;0.12 PQ: 0 ANSI: 5</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.612000] sd 0:0:0:0: Attached scsi generic sg0 type 0</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.612000] scsi 1:0:0:0: CD-ROM &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QEMU &nbsp; &nbsp; QEMU DVD-ROM &nbsp; &nbsp; 0.12 PQ: 0 ANSI: 5</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.616000] sd 0:0:0:0: [sda] 0 512-byte logical blocks: (0 B/0 B)</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.616000] sr0: scsi3-mmc drive: 4x/4x xa/form2 tray</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.620000] cdrom: Uniform CD-ROM driver Revision: 3.20</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.620000] sd 0:0:0:0: [sda] Write Protect is off</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.620000] sd 0:0:0:0: [sda] Write cache: disabled, read cache: enabled, doesn't support DPO or FUA</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.624000] sr 1:0:0:0: Attached scsi generic sg1 type 5</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.624000] sd 0:0:0:0: [sda] Attached SCSI disk</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.624000] md: Waiting for all devices to be available before autodetect</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.624000] md: If you don't use raid, use raid=noautodetect</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.628000] md: Autodetecting RAID arrays.</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.628000] md: Scanned 0 and added 0 devices.</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.628000] md: autorun ...</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.628000] md: ... autorun DONE.</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.628000] RAMDISK: gzip image found at block 0</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.780000] VFS: Mounted root (ext2 filesystem) readonly on device 1:0.</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.784000] devtmpfs: mounted</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.784000] Freeing prom memory: 956k freed</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">[ &nbsp; &nbsp;0.796000] Freeing unused kernel memory: 380k freed</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">can't run '/etc/init.d/rcS': No such file or directory</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">Please press Enter to activate this console.&nbsp;</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">/ # ls</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">bin &nbsp; &nbsp; &nbsp; &nbsp; linuxrc &nbsp; &nbsp; proc &nbsp; &nbsp; &nbsp; &nbsp;sys</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">dev &nbsp; &nbsp; &nbsp; &nbsp; lost+found &nbsp;sbin &nbsp; &nbsp; &nbsp; &nbsp;usr</span></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">/ #&nbsp;</span></div></div><div><span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;"><br /></span></div></div></div>
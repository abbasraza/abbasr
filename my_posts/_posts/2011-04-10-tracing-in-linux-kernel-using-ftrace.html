---
layout: post
title: Debugging the Linux kernel using ftrace [Part 1]
date: '2011-04-10T23:29:00.003+05:00'
author: Abbas Raza
tags:
- ftrace
- kernel trace
- debugfs
- kernel debug
modified_time: '2011-04-10T23:40:27.081+05:00'
blogger_id: tag:blogger.com,1999:blog-3367966882409306161.post-5603347490156252039
blogger_orig_url: https://abbas-raza.blogspot.com/2011/04/tracing-in-linux-kernel-using-ftrace.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div class="title" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><h1><a class="contentpagetitle" href="http://quadstor.com/tech-articles/104-linux-kernel-function-tracing-using-ftrace.html">   </a>  </h1></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><u><b>Ftrace:</b></u><br /><br />Ftrace is a tracing utility built directly into the Linux kernel. Many distributions already have various configurations of Ftrace enabled in their most recent releases. One of the benefits that Ftrace brings to Linux  is the ability to see what is happening inside the kernel.  As such, this makes finding problem areas or simply tracking down that strange bug more manageable.  </div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">Ftrace's ability to show the events that lead up to a crash gives a better chance of finding exactly what caused it and can help the developer in creating the correct solution. This article is a two part series that will cover various methods of using Ftrace for debugging the Linux kernel. This first part will talk briefly about setting up Ftrace, using the function tracer, writing to the Ftrace buffer from within the kernel, and various ways to stop the tracer when a problem is detected.</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">Steps to enable tracing and then using it..</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><b>1) Enable tracing support in kernel: </b></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">In order to enable tracing for your kernel be sure to select "Tracers"  in the kernel config and the relevant tracers you need. Selecting and  enabling all available traces should be alright as we can choose the  tracer at runtime.</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><b>2) Mounting debugfs:</b></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">Ftrace uses the debugfs file system to hold the control files as well as the files to display output. </div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">When debugfs is configured into the kernel (which selecting any ftrace option will do) the directory /sys/kernel/debug will be created. To mount this directory, you can add to your <b>/etc/fstab</b> file:&nbsp;</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i>debugfs       /sys/kernel/debug          debugfs defaults        0       0</i></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"></pre><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">Or you can mount it at run time with:&nbsp;</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i>mount -t debugfs nodev /sys/kernel/debug</i></pre><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="l"></span>After mounting the debugfs, you can see a directory called<br /><span class="l"><a href="http://www.mjmwired.net/kernel/Documentation/trace/ftrace.txt#65" name="65"></a></span>"<i>tracing</i>".  This directory contains the control and output files<br /><span class="l"><a href="http://www.mjmwired.net/kernel/Documentation/trace/ftrace.txt#66" name="66"></a></span>of ftrace.&nbsp;</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;</pre><pre style="background-color: white; font-family: &quot;Courier New&quot;,Courier,monospace;"><u><b>list of some of the key files:</b></u></pre><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">current_tracer:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This is used to set or display the current tracer</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; that is configured.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">available_tracers:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This holds the different types of tracers that</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; have been compiled into the kernel. The</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tracers listed here can be configured by</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echoing their name into current_tracer.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">tracing_enabled:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This sets or displays whether the current_tracer</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is activated and tracing or not. Echo 0 into this</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file to disable the tracer or 1 to enable it.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">trace:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This file holds the output of the trace in a human</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; readable format (described below).</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">trace_pipe:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The output is the same as the "trace" file but this</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file is meant to be streamed with live tracing.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Reads from this file will block until new data is</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; retrieved.&nbsp; Unlike the "trace" file, this file is a</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; consumer. This means reading from this file causes</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sequential reads to display more current data. Once</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data is read from this file, it is consumed, and</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; will not be read again with a sequential read. The</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "trace" file is static, and if the tracer is not</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; adding more data,they will display the same</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; information every time they are read.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">trace_options:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This file lets the user control the amount of data</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; that is displayed in one of the above output</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; files.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">tracing_max_latency:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Some of the tracers record the max latency.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For example, the time interrupts are disabled.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This time is saved in this file. The max trace</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; will also be stored, and displayed by "trace".</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; A new max trace will only be recorded if the</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; latency is greater than the value in this</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file. (in microseconds)</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">buffer_size_kb:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This sets or displays the number of kilobytes each CPU</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buffer can hold. The tracer buffers are the same size</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for each CPU. The displayed number is the size of the</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CPU buffer and not total size of all buffers. The</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trace buffers are allocated in pages (blocks of memory</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; that the kernel uses for allocation, usually 4 KB in size).</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If the last page allocated has room for more bytes</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; than requested, the rest of the page will be used,</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; making the actual allocation bigger than requested.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ( Note, the size may not be a multiple of the page size</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; due to buffer management overhead. )</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This can only be updated when the current_tracer</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is set to "nop".</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">tracing_cpumask:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This is a mask that lets the user only trace</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on specified CPUS. The format is a hex string</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; representing the CPUS.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">set_ftrace_filter:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; When dynamic ftrace is configured in (see the</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; section below "dynamic ftrace"), the code is dynamically</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; modified (code text rewrite) to disable calling of the</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function profiler (mcount). This lets tracing be configured</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in with practically no overhead in performance.&nbsp; This also</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; has a side effect of enabling or disabling specific functions</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; to be traced. Echoing names of functions into this file</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; will limit the trace to only those functions.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This interface also allows for commands to be used. See the</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Filter commands" section for more details.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">set_ftrace_notrace:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This has an effect opposite to that of</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set_ftrace_filter. Any function that is added here will not</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; be traced. If a function exists in both set_ftrace_filter</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and set_ftrace_notrace, the function will _not_ be ed.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">set_ftrace_pid:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Have the function tracer only trace a single thread.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">set_graph_function:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Set a "trigger" function where tracing should start</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; with the function graph tracer (See the section</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "dynamic ftrace" for more details).</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">available_filter_functions:</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This lists the functions that ftrace</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; has processed and can trace. These are the function</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; names that you can pass to "set_ftrace_filter" or</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "set_ftrace_notrace". (See the section "dynamic ftrace"</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; below for more details.)</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="background-color: white; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: small;"><u><b><span style="line-height: 115%;">The Tracers:</span></b></u></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;"></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">Here is the list of current tracers that may be configured.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"function"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Function call tracer to trace all kernel functions.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"function_graph"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Similar to the function tracer except that the</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function tracer probes the functions on their entry</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereas the function graph tracer traces on both entry</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and exit of the functions. It then provides the ability</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; to draw a graph of function calls similar to C code</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"sched_switch"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Traces the context switches and wakeups between tasks.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"irqsoff"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Traces the areas that disable interrupts and saves</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; the trace with the longest max latency.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; See tracing_max_latency. When a new max is recorded,</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; it replaces the old trace. It is best to view this</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trace with the latency-format option enabled.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"preemptoff"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Similar to irqsoff but traces and records the amount of</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; time for which preemption is disabled.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"preemptirqsoff"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Similar to irqsoff and preemptoff, but traces and</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; records the largest time for which irqs and/or preemption</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is disabled.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"wakeup"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Traces and records the max latency that it takes for</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; the highest priority task to get scheduled after</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; it has been woken up.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"hw-branch-tracer"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Uses the BTS CPU feature on x86 CPUs to traces all</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; branches executed.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp; <span style="background-color: yellow;">"nop"</span></span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This is the "trace nothing" tracer. To remove all</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tracers from tracing simply echo "nop" into</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: 10pt; line-height: 115%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current_tracer.</span></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div class="MsoNormal" style="font-family: &quot;Courier New&quot;,Courier,monospace;"><b>3) Start Tracing </b></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i># cd /sys/kernel/debug/tracing</i></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i>&nbsp;</i></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i># echo function &gt; current_tracer<br />&nbsp;</i></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i># echo 1 &gt; tracing_enabled<br />&nbsp;</i></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i># usleep 1<br />&nbsp;</i></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i># echo 0 &gt; tracing_enabled</i><br />&nbsp;</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><i># cat trace</i><br />&nbsp;</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"># tracer: function<br />#<br />#           TASK-PID   CPU#    TIMESTAMP  FUNCTION<br />#              | |      |          |         |<br />            bash-4003  [00]   123.638713: finish_task_switch &lt;-schedule<br />            bash-4003  [00]   123.638714: _spin_unlock_irq &lt;-finish_task_switch<br />            bash-4003  [00]   123.638714: sub_preempt_count &lt;-_spin_unlock_irq<br />            bash-4003  [00]   123.638715: hrtick_set &lt;-schedule<br />            bash-4003  [00]   123.638715: _spin_lock_irqsave &lt;-hrtick_set<br />            bash-4003  [00]   123.638716: add_preempt_count &lt;-_spin_lock_irqsave<br />            bash-4003  [00]   123.638716: _spin_unlock_irqrestore &lt;-hrtick_set<br />            bash-4003  [00]   123.638717: sub_preempt_count &lt;-_spin_unlock_irqrestore<br />            bash-4003  [00]   123.638717: hrtick_clear &lt;-hrtick_set<br />            bash-4003  [00]   123.638718: sub_preempt_count &lt;-schedule<br />            bash-4003  [00]   123.638718: sub_preempt_count &lt;-preempt_schedule<br />            bash-4003  [00]   123.638719: wait_for_completion &lt;-__stop_machine_run<br />            bash-4003  [00]   123.638719: wait_for_common &lt;-wait_for_completion<br />            bash-4003  [00]   123.638720: _spin_lock_irq &lt;-wait_for_common<br />            bash-4003  [00]   123.638720: add_preempt_count &lt;-_spin_lock_irq<br />[...]</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">Clearing trace</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"># echo 0 &gt; trace</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;"><u><b>Whats Next: </b></u></pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">In next posts i will try to explore other features of ftrace like&nbsp;</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">using debug buffer size and tracing a  single thread, enabling and</pre><pre style="font-family: &quot;Courier New&quot;,Courier,monospace;">disabling tracing from inside code etc.</pre></div>